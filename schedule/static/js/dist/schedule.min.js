function ajax(a,b){return new Ember.RSVP.Promise(function(c,d){b=b||{},b.url=a,Ember.$.ajax(b).done(function(a){"Success"==a.response?c(a):d(new Error(a.message))}).fail(function(b,c,e){d(new Error("AJAX: `"+a+"` failed with status: ["+c+"] "+e))})})}function setMenu(a){Ember.$("ul.navbar-nav li");$("ul.navbar-nav li").each(function(){var b=$(this);b.attr("id")==a.get("menu")?$(b).toggleClass("active",!0):$(b).toggleClass("active",!1)})}App=Ember.Application.create({LOG_TRANSITIONS:!0}),App.Router.map(function(){this.resource("index",{path:"/"}),this.resource("person",{path:"/people/:id"}),this.resource("person_create",{path:"/people/new"}),this.resource("person_edit",{path:"/people/:id/edit"}),this.resource("people",{path:"/people"}),this.resource("people_page",{path:"/people/page/:page_no"}),this.resource("events",{path:"/events/"}),this.resource("event",{path:"/events/:event_id"},function(){this.resource("event_date",{path:"/event_date/:event_date_id"})}),this.resource("event_overview",{path:"/events/:event_id/overview"})}),App.EventsController=Ember.ObjectController.extend({menu:"nav-events",reset:function(){setMenu(this)}}),App.EventController=Ember.ObjectController.extend({menu:"nav-events",datesRangeSelected:"12",ranges:[{value:"12",name:"Upcoming"},{value:"-12",name:"Recent"}],datesLoading:!1,frequencies:[{value:"weekly",name:"Weekly"},{value:"monthly",name:"Monthly"},{value:"irregular",name:"Never"}],d_errors:null,reset:function(){setMenu(this)},getPermissions:function(){var a=this;App.Person.permissions().then(function(b){a.set("permissions",b.permissions),a.isEventAdmin(a.get("model").id)})},reset:function(){setMenu(this)},isEventAdmin:function(a){return this.set("canAdministrate",!1),this.get("permissions").is_admin?void this.set("canAdministrate",!0):void this.get("permissions").events_admin.forEach(function(b){return b.id==a?void this.set("canAdministrate",!0):void 0})},datesRangeChange:function(){var a=this;a.set("datesLoading",!0),App.EventDate.getAll(this.get("model").id,this.get("datesRangeSelected")).then(function(b){var c=b.event_dates.map(function(a){return App.EventDate.create(a)});a.set("event_dates",c),a.set("datesLoading",!1)}).catch(function(b){a.set("error",b.message)})}.observes("datesRangeSelected"),actions:{createEventDates:function(a){console.log(a);var b={frequency:a.frequency,repeats_every:1,day_mon:a.day_mon,day_tue:a.day_tue,day_wed:a.day_wed,day_thu:a.day_thu,day_fri:a.day_fri,day_sat:a.day_sat,day_sun:a.day_sun,from_date:a.from_date,to_date:a.to_date},c=this;App.Event.createDates(a.id,b).then(function(){Ember.$("#dialog-form").modal("hide"),c.transitionToRoute("event",c.get("model").get("id"))}).catch(function(a){c.set("d_error",a)})}}}),App.EventOverviewController=Ember.ObjectController.extend({from_date:moment().format("YYYY-MM-DD"),getPermissions:function(){var a=this;App.Person.permissions().then(function(b){a.set("permissions",b.permissions),a.isEventAdmin(a.get("model").id)})},isEventAdmin:function(a){return this.set("canAdministrate",!1),this.get("permissions").is_admin?void this.set("canAdministrate",!0):void this.get("permissions").events_admin.forEach(function(b){return b.id==a?void this.set("canAdministrate",!0):void 0})},actions:{fromDateChange:function(){var a=this,b={from_date:this.get("from_date")};App.Event.overview(this.get("model").event_id,b).then(function(b){a.set("model",b.event_dates)}).catch(function(b){a.set("error",b.message)})}.observes("from_date"),editEventDate:function(a){a.set("isEditing",!0)},cancelEventDate:function(a){a.set("isEditing",!1)},saveEventDate:function(a){var b=[];a.get("rota").forEach(function(a){b.addObject({role_id:a.role.id,person_id:a.person_id||0})});var c=this,d={focus:a.get("focus"),notes:a.get("notes"),rota:b};App.EventDate.updateRota(a.id,d).then(function(b){a.set("isEditing",!1);var d=App.EventDate.create(b.event_date),e=c.get("model").event_dates.indexOf(a),f=c.get("model").event_dates;f[e]=d,c.get("model").event_dates.setObjects(f)}).catch(function(a){c.set("error",a.message)})}}}),App.EventDateController=Ember.ObjectController.extend({isEditing:!1,eventDataLoading:!1,eventDateForm:{},eventDateError:null,getPermissions:function(){var a=this;App.Person.permissions().then(function(b){a.set("permissions",b.permissions),a.isEventAdmin(a.get("model").event_id)})},isEventAdmin:function(a){return this.set("canAdministrate",!1),this.get("permissions").is_admin?void this.set("canAdministrate",!0):void this.get("permissions").events_admin.forEach(function(b){return b.id==a?void this.set("canAdministrate",!0):void 0})},actions:{editEventDate:function(){this.set("isEditing",!0)},saveEventDate:function(a){this.set("eventDataLoading",!0);var b=[];a.get("rota").forEach(function(a){b.addObject({role_id:a.role.id,person_id:a.person_id||0})});var c=this,d={focus:a.get("focus"),notes:a.get("notes"),rota:b};App.EventDate.updateRota(this.get("model").id,d).then(function(){c.set("isEditing",!1),c.set("eventDataLoading",!1),c.send("reloadModel")}).catch(function(a){c.set("error",a.message)})},removeEventDate:function(a){this.set("confirmHeader","Confirm Deletion"),this.set("confirmBody","Delete event date?"),this.set("eventDateForm",a),Ember.$("#confirmModal").modal("show")},confirmYes:function(){var a=this;App.EventDate.delete(this.get("model").id).then(function(){a.set("eventDateForm",{}),Ember.$("#confirmModal").modal("hide"),a.transitionToRoute("event",a.get("model").event_id)})},cancelEventDate:function(){this.set("isEditing",!1)}}}),App.Event=Ember.Object.extend({}),App.Event.reopenClass({url:"/api/events",findById:function(a){return ajax(this.url+"/"+a,{type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"})},getAll:function(){return ajax(this.url,{type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"})},createDates:function(a,b){return ajax("/api/events/"+a+"/event_dates/create",{type:"POST",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json"})},overview:function(a,b){return ajax("/api/events/"+a+"/overview",{type:"POST",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json"})}}),App.EventDate=Ember.Object.extend({}),App.EventDate.reopenClass({url:"/api/event_date/",getAll:function(a,b){return ajax("/api/events/"+a+"/event_dates",{type:"POST",data:JSON.stringify({range:b}),contentType:"application/json; charset=utf-8",dataType:"json"})},findById:function(a){return ajax(this.url+a,{type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"})},updateRota:function(a,b){return ajax(this.url+a,{type:"POST",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json"})},"delete":function(a){return ajax(this.url+a,{type:"DELETE",data:JSON.stringify({eventId:a}),contentType:"application/json; charset=utf-8",dataType:"json"})}}),App.EventsRoute=Ember.Route.extend({model:function(){return App.Event.getAll().then(function(a){return a.events})},setupController:function(a,b){a.set("content",b),a.reset()}}),App.EventRoute=Ember.Route.extend({model:function(a){return App.Event.findById(a.event_id).then(function(a){return App.Event.create(a.event)})},setupController:function(a,b){a.set("content",b),a.getPermissions(),a.reset(),a.datesRangeChange()},actions:{reloadModel:function(){this.refresh()}}}),App.EventDateRoute=Ember.Route.extend({model:function(a){return App.EventDate.findById(a.event_date_id).then(function(a){return App.EventDate.create(a.event_date)})},actions:{reloadModel:function(){this.refresh()}},setupController:function(a,b){a.set("content",b),a.getPermissions(),a.set("eventDataLoading",!1),a.set("isEditing",!1)}}),App.EventOverviewRoute=Ember.Route.extend({model:function(a){return App.Event.overview(a.event_id,{}).then(function(a){var b=a.event_dates.event_dates.map(function(a){return App.EventDate.create(a)});a.event_dates.event_dates=b;var c=App.Event.create(a.event_dates);return c})},setupController:function(a,b){a.set("content",b),a.getPermissions(),b.event_dates||(console.log("No Dates"),this.refresh())}}),App.PersonController=Ember.ObjectController.extend({menu:"nav-myrota",rotaRangeSelected:"52",ranges:[{value:"52",name:"Upcoming"},{value:"-12",name:"Recent"}],rotaLoading:!1,awayRangeSelected:"52",awayLoading:null,awayForm:{},awayError:null,reset:function(){setMenu(this)},getPermissions:function(){var a=this;App.Person.permissions().then(function(b){a.set("permissions",b.permissions),a.isPersonAdmin()})},isPersonAdmin:function(){this.set("canAdministratePerson",!1),this.get("permissions").is_admin?this.set("canAdministratePerson",!0):this.get("model").id==this.get("permissions").user_id&&this.set("canAdministratePerson",!0)},rotaRangeChange:function(){var a=this;a.set("rotaLoading",!0),App.Person.rota(this.get("model").id,this.get("rotaRangeSelected")).then(function(b){a.set("rota",b.rota),a.set("rotaLoading",!1)})}.observes("rotaRangeSelected"),awayRangeChange:function(){var a=this;a.set("awayLoading",!0),App.Person.awayDates(this.get("model").id,this.get("awayRangeSelected")).then(function(b){a.set("away_dates",b.away_dates),a.set("awayLoading",!1)})}.observes("awayRangeSelected"),actions:{newAwayDates:function(){this.set("awayForm",{}),this.set("awayError",null),Ember.$("#awayModal").modal("show")},saveAwayDate:function(){var a=this;App.Person.upsertAwayDate(this.get("model").id,this.get("awayForm")).then(function(b){var c=!1,d=a.get("away_dates").map(function(a){return a.id===b.away_date.id?(c=!0,b.away_date):a});c||d.addObject(b.away_date),a.get("away_dates").setObjects(d),Ember.$("#awayModal").modal("hide")}).catch(function(b){a.set("awayError",b.message)})},editAwayDate:function(a){this.set("awayForm",{id:a.id,from_date:a.from_date,to_date:a.to_date}),this.set("awayError",null),Ember.$("#awayModal").modal()},deleteAwayDate:function(a){this.set("confirmHeader","Confirm Deletion"),this.set("confirmBody","Delete away date?"),this.set("awayForm",a),Ember.$("#confirmModal").modal("show")},confirmYes:function(){var a=this;App.Person.deleteAwayDate(this.get("model").id,this.get("awayForm")).then(function(){a.get("away_dates").removeObject(a.get("awayForm")),a.set("awayForm",{}),Ember.$("#confirmModal").modal("hide")})},refreshRota:function(){this.rotaRangeChange()},refreshAwayDates:function(){this.awayRangeChange()}}}),App.PeoplePageController=Ember.ArrayController.extend({menu:"nav-people",stateSelected:"active",states:[{value:"active",name:"Active Only"},{value:"inactive",name:"Inactive Only"},{value:"any",name:"Active & Inactive"}],getPermissions:function(){var a=this;App.Person.permissions().then(function(b){a.set("permissions",b.permissions)})},reset:function(){setMenu(this),this.set("stateSelected","active"),this.set("find_firstname",null),this.set("find_lastname",null)},actions:{findPeople:function(){var a={firstname:this.get("find_firstname"),lastname:this.get("find_lastname"),active:this.get("stateSelected")},b=this;App.Person.find(a).then(function(a){b.get("content").setObjects(a.people),b.set("meta",a.meta)}).catch(function(a){b.set("error",a.message)})},clearFind:function(){this.set("stateSelected","active"),this.set("find_firstname",null),this.set("find_lastname",null),this.transitionToRoute("people")}}}),App.PersonCreateController=Ember.ObjectController.extend({menu:"nav-people",roles:[{value:"standard",name:"Standard"},{value:"admin",name:"Admin"}],user_role:"standard",firstname:null,lastname:null,email:null,guest:null,error:null,reset:function(){this.set("error",null),this.set("firstname",null),this.set("lastname",null),this.set("email",null),this.set("user_role","standard")},actions:{saveNewPerson:function(){var a={firstname:this.get("firstname"),lastname:this.get("lastname"),email:this.get("email"),user_role:this.get("user_role"),guest:this.get("guest")},b=this;b.set("error",null),App.Person.createNew(a).then(function(){b.transitionToRoute("people")}).catch(function(a){b.set("error",a.message)})}}}),App.PersonEditController=Ember.ObjectController.extend({menu:"nav-people",roles:[{value:"standard",name:"Standard"},{value:"admin",name:"Admin"}],actions:{savePerson:function(a){var b=this;b.set("error",null),App.Person.edit(this.get("model").id,a).then(function(){b.transitionToRoute("people")}).catch(function(a){b.set("error",a.message)})}}});var DATE_FORMAT="DD/MM/YYYY";Ember.Handlebars.registerBoundHelper("formatDate",function(a){return a?moment(a,"YYYY-MM-DD").format(DATE_FORMAT):""}),Ember.Handlebars.registerBoundHelper("shortDate",function(a){return a?moment(a,"YYYY-MM-DD").format("DD MMM"):""}),Ember.Handlebars.registerBoundHelper("dateFromNow",function(a){return a?moment.utc(a,"YYYY-MM-DDThh:mm:ss").fromNow():""}),App.CalendarDatePicker=Ember.TextField.extend({_picker:null,modelChangedValue:function(){var a=this.get("_picker");a&&a.setDate(this.get("value"))}.observes("value"),didInsertElement:function(){var a=(new Date).getFullYear(),b=this.$()[0],c=new Pikaday({field:b,yearRange:[1900,a+2],format:"YYYY-MM-DD"});this.set("_picker",c)},willDestroyElement:function(){var a=this.get("_picker");a&&a.destroy(),this.set("_picker",null)}}),App.Person=Ember.Object.extend({}),App.Person.reopenClass({url:"/api/people",findById:function(a){return a&&"undefined"!==a||(a="me"),ajax(this.url+"/"+a,{type:"GET",contentType:"application/json; charset=utf-8",dataType:"json"})},find:function(a){return ajax(this.url+"/find",{type:"POST",data:JSON.stringify(a),contentType:"application/json; charset=utf-8",dataType:"json"})},rota:function(a,b){var c={range:null};return b&&(c.range=b),a||(a="me"),ajax(this.url+"/"+a+"/rota",{type:"POST",data:JSON.stringify(c),contentType:"application/json; charset=utf-8",dataType:"json"})},awayDates:function(a,b){var c={range:null};return b&&(c.range=b),a||(a="me"),ajax(this.url+"/"+a+"/away_dates",{type:"POST",data:JSON.stringify(c),contentType:"application/json; charset=utf-8",dataType:"json"})},upsertAwayDate:function(a,b){return ajax(this.url+"/"+a+"/away_date",{type:"POST",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json"})},deleteAwayDate:function(a,b){return ajax(this.url+"/"+a+"/away_date",{type:"DELETE",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json"})},getAll:function(a){var b=this.url;return a&&(b=this.url+"/page/"+a),ajax(b,{type:"GET",contentType:"application/json; charset=utf-8"})},createNew:function(a){return ajax(this.url+"/new",{type:"POST",data:JSON.stringify(a),contentType:"application/json; charset=utf-8",dataType:"json"})},edit:function(a,b){return ajax(this.url+"/"+a,{type:"POST",data:JSON.stringify(b),contentType:"application/json; charset=utf-8",dataType:"json"})},permissions:function(){return ajax("/api/permissions",{type:"POST",data:JSON.stringify({}),contentType:"application/json; charset=utf-8",dataType:"json"})}}),App.IndexRoute=Ember.Route.extend({beforeModel:function(){this.transitionTo("person","me")}}),App.PersonRoute=Ember.Route.extend({model:function(a){return"undefined"===a.id&&this.transitionTo("person","me"),App.Person.findById(a.id).then(function(a){return a.person})},setupController:function(a,b){a.set("content",b),a.getPermissions(),a.reset(),a.rotaRangeChange(),a.awayRangeChange()}}),App.PeopleRoute=Ember.Route.extend({beforeModel:function(){this.transitionTo("people_page",1)}}),App.PeoplePageRoute=Ember.Route.extend({model:function(a){console.log("PeoplePageRoute");var b=null;return a.page_no&&(b=a.page_no),App.Person.getAll(b).then(function(a){return a})},setupController:function(a,b){a.getPermissions(),a.set("content",b.people),a.set("meta",b.meta),a.reset()}}),App.PersonCreateRoute=Ember.Route.extend({setupController:function(a){a.reset()}});